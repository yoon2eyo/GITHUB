@startuml
left to right direction
!pragma layout smetana
allowmixing
skinparam componentStyle rectangle
skinparam backgroundColor transparent
skinparam packageStyle rectangle
skinparam portStyle solid
skinparam interfaceStyle rectangle

title Business Logic (src) - Service Level Overview

' External clients and broker
actor "Client" as Client
queue "Message Broker" as Broker

package "API Gateway" as GW {
  portin "ingress" as ingress
  portout "downstream" as downstream

  interface "IApiGatewayEntry" as IEntry {
    + routeRequest(request: ClientRequest): ServiceResponse
  }

  interface "IAuthenticationClient" as IAuthClient {
    + validateToken(token: String): boolean
  }

  component "RequestRouter" as Router
  component "InternalClientManager" as ICM
  component "RequestSignatureVerifier" as SigVerifier
  component "NetworkZonePolicy" as ZonePolicy
  interface "ServiceDiscovery" as IDisc {
    + resolveAndBalance(servicePath: String): String
    + getServiceInstances(servicePath: String): List<String>
  }

  note bottom of Router : Front controller, TLS signature verification,\nnetwork zone enforcement, routing
}

package "Auth Service" as AS {
  portin "api_in" as api_in_auth
  portout "events" as events_auth

  interface "IAuthServiceApi" as IAuthAPI {
    + login(credentials: UserCredentials): AuthToken
    + validateToken(token: String): boolean
    + registerUser(details: RegistrationDetails): void
  }

  interface "IAuthRepository" as IAuthRepo
  interface "ICreditCardVerificationService" as ICCV
  interface "IMessagePublisherService" as IPubAuth

  component "AuthorizationManager" as AM
  component "TokenService" as TS
}

package "Search Service" as SS {
  portin "api_in" as api_in_search
  portin "broker_in" as broker_in_search
  portout "events" as events_search

  interface "ISearchServiceApi" as ISearchAPI
  interface "ISearchRepository" as ISearchRepo
  interface "ILLMAnalysisService" as ILLM
  interface "IMessagePublisherService" as IPubSearch
  interface "IMessageSubscriptionService" as ISubSearch

  component "SearchManager" as SM
  component "PreferenceMatchConsumer" as PMC
  component "LLM Keyword Stage" as LLMStage
  component "DS-07 Index Stage" as IndexStage
  component "DS-07 Search Index" as DS07Index
  component "PreferenceMatchScheduler" as PMS
  component "SchedulingPolicyWindow" as SchedWindow
}

package "Helper Service" as HS {
  portin "api_in" as api_in_helper
  portout "broker_out" as events_helper

  interface "IHelperServiceApi" as IHelperAPI
  interface "IHelperRepository" as IHelperRepo
  interface "IPanDokuModelService" as IPanDoku
  interface "IMessagePublisherService" as IPubHelper
  interface "IMessageSubscriptionService" as ISubHelper

  component "TaskManagementManager" as TMM
  component "RewardConfirmationManager" as RCM
  component "AIPanDokuConsumer" as APC
  component "RewardUpdateConsumer" as RUC
}

package "Monitoring Service" as MS {
  portin "status_in" as status_in
  portin "timer_in" as timer_in
  portout "events" as events_monitor

  interface "IEquipmentStatusService" as IStatus
  interface "IMonitoringTriggerService" as ITrig
  interface "IMonitorRepository" as IMonitorRepo
  interface "IMessagePublisherService" as IPubMon

  component "StatusReceiverManager" as SRM
  component "HeartbeatChecker" as HBC
}

package "Real-Time Access Service" as RTAS {
  portout "events" as events_access

  interface "IMessagePublisherService" as IPubAccess
}

package "Notification Dispatcher" as ND {
  portin "fault_topic" as fault_in
  portout "push_out" as push_out

  interface "IPushNotificationGateway" as IPushGateway

  component "NotificationDispatcher" as NDispatch
}

component "Push Notification Service" as PushSvc

' Implementations (provided APIs)
Router ..|> IEntry
AM ..|> IAuthAPI
SM ..|> ISearchAPI
SRM ..|> IStatus
HBC ..|> ITrig

' Required dependencies
Router -( IAuthClient
Router -( SigVerifier
Router -( ZonePolicy
AM -( IAuthRepo
AM -( ICCV
AM -( IPubAuth
SM -( ISearchRepo
SM -( ILLM
SM -( IPubSearch
PMC -( ISubSearch
PMS --> PMC : drainBufferedEvents()
PMS -( ISearchRepo
PMS --> SchedWindow : checkWindow()
LLMStage -( ILLM
IndexStage -( ISearchRepo
TMM -( IHelperRepo
TMM -( IPanDoku
RCM -( IHelperRepo
RCM -( IPubHelper
APC -( ISubHelper
APC -( IPanDoku
APC -( IHelperRepo
RUC -( ISubHelper
RUC -( IHelperRepo
SRM -( IMonitorRepo
SRM -( IPubMon
HBC -( IMonitorRepo
HBC -( IPubMon
NDispatch -( IPushGateway
ICM -( IDisc

' Internal interactions per service
Router --> ICM : forwardRequest()
AM --> TS : issue/validate token
PMC --> SM : subscription-driven matching
SM --> LLMStage : extractKeywords()
LLMStage --> IndexStage : persistKeywords()
IndexStage --> DS07Index : updateIndex()
SM --> ISearchRepo : executeMatchQuery()
PMS --> ISearchRepo : batchMatch()

' Service-to-service calls (logical, via adapters or HTTP/gRPC)
Client --> ingress : routeRequest
ingress --> IEntry
Router --> IAuthAPI : validateToken(token)
Router --> ISearchAPI : /search/*
Router --> IHelperAPI : /helper/*

' Event flows (topic-based)
IPubAuth --> Broker : publishEvent("users", event)
IPubSearch --> Broker : publishEvent("preferences", event)
IPubHelper --> Broker : publishEvent("tasks.submitted", event)
IPubHelper --> Broker : publishEvent("tasks.confirmed", event)
IPubMon --> Broker : publishEvent("faults", event)
IPubAccess --> Broker : publishEvent("access", event)
Broker --> ISubSearch : deliver("preferences")
Broker --> ISubHelper : deliver("tasks.*")
Broker --> fault_in : deliver("faults")
fault_in --> NDispatch : subscribe("faults")
NDispatch --> IPushGateway : fan-out alert
IPushGateway --> push_out : sendPush()
push_out --> PushSvc : admin push

legend right
  Service-level overview from src packages
  - Provided interfaces and implementing components
  - Required dependencies (repos, external clients, broker)
  - Gateway routing and inter-service calls
  - Event publishing to message broker
end legend

@enduml
