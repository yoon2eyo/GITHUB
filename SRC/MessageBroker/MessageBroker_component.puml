@startuml
!pragma layout smetana
allowmixing
skinparam componentStyle rectangle
skinparam backgroundColor transparent
skinparam packageStyle rectangle
skinparam portStyle solid
skinparam interfaceStyle rectangle

title Message Broker & Persistence Adapters

package "Messaging Interfaces" {
  interface "IMessagePublisherService" as IPublisher {
    + publishEvent(topic: String, event: DomainEvent)
  }
  interface "IMessageSubscriptionService" as ISubscriber {
    + subscribeToTopic(topic: String, handler)
  }
}

package "Messaging Implementation" {
  component "MessageBrokerComponent" as MessageBroker
  note bottom of MessageBroker : Concurrent topic routing + thread pool dispatch\nimplements publisher & subscription ports
}

package "Domain Events" {
  interface "DomainEvent" as DomainEvent
  class "UserRegisteredEvent" as UserRegisteredEvent
  class "BranchPreferenceCreatedEvent" as BranchPreferenceCreatedEvent
  class "TaskSubmittedEvent" as TaskSubmittedEvent
  class "TaskConfirmedEvent" as TaskConfirmedEvent
  class "EquipmentFaultDetectedEvent" as EquipmentFaultDetectedEvent
  class "AccessAttemptEvent" as AccessAttemptEvent
}

package "Repository Ports" {
  interface "IAuthRepository" as IAuthRepo
  interface "IHelperRepository" as IHelperRepo
  interface "ISearchRepository" as ISearchRepo
  interface "IMonitorRepository" as IMonitorRepo
  interface "IAccessVectorRepository" as IAccessRepo
}

package "Repository Implementations" {
  component "AuthRepositoryImpl" as AuthRepoImpl
  component "HelperRepositoryImpl" as HelperRepoImpl
  component "SearchRepositoryImpl" as SearchRepoImpl
  component "MonitorRepositoryImpl" as MonitorRepoImpl
  component "AccessVectorRepositoryImpl" as AccessVectorRepoImpl
  note bottom of AuthRepoImpl : DB_AUTH DAL
  note bottom of HelperRepoImpl : DB_HELPER DAL
  note bottom of SearchRepoImpl : DB_SEARCH / Branch index DAL
  note bottom of MonitorRepoImpl : DB_MONITOR DAL
  note bottom of AccessVectorRepoImpl : DS-02 face vector storage
}

database "Shared DataSource" as DataSource

' Messaging relationships
MessageBroker ..|> IPublisher
MessageBroker ..|> ISubscriber
IPublisher ..> DomainEvent : payload
ISubscriber ..> DomainEvent : payload

' Repository relationships
AuthRepoImpl ..|> IAuthRepo
HelperRepoImpl ..|> IHelperRepo
SearchRepoImpl ..|> ISearchRepo
MonitorRepoImpl ..|> IMonitorRepo
AccessVectorRepoImpl ..|> IAccessRepo

' DataSource wiring
AuthRepoImpl --> DataSource
HelperRepoImpl --> DataSource
SearchRepoImpl --> DataSource
MonitorRepoImpl --> DataSource
AccessVectorRepoImpl --> DataSource

legend right
  Message Broker module
  - IPublisher / ISubscriber contracts + implementation
  - Domain events routed asynchronously
  Persistence adapters
  - RepositoryImpl classes for each service
  - All rely on injected JDBC DataSource
end legend

@enduml
