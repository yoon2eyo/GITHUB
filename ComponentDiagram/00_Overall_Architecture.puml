@startuml OverallComponentDiagram
!pragma layout smetana
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam backgroundColor transparent

actor "Customer App" as Customer
actor "Helper App" as Helper
actor "Branch Manager App" as Manager
actor "Operations Center" as Ops

cloud "External Partners" {
  component "ICreditCardVerificationService" as CC
  component "ILLMAnalysisService" as ExtLLM
}

node "Branch Equipment & Cameras" as Equipment
component "IPushNotificationGateway" as PushGW

rectangle "Smart Fitness Cloud" {
  component "RequestRouter" as Gateway
  queue "MessageBrokerComponent" as Broker

  package "Core Services" {
    component "AuthenticationManager" as Auth
    component "BranchContentService" as Search
    component "TaskManagementManager" as HelperSvc
    component "BranchOwnerManager" as BranchOwner
    component "AccessAuthorizationManager" as Access
    component "StatusReceiverManager" as Monitor
    component "NotificationDispatcherConsumer" as Notify
    component "LLMKeywordExtractor" as AIService
  }

  package "AI & ML Services" {
    component "FaceModelServiceComponent" as FaceModel
    component "IPanDokuModelService (Internal ML Engine)" as PanDoku [Internal]
  }
}

Customer --> Gateway : HTTPS /auth,/search
Helper --> Gateway : HTTPS /helper
Manager --> Gateway : HTTPS /branch
Ops --> Gateway : HTTPS /ops console

Gateway --> Auth : <<HTTP>>
Gateway --> Search : <<HTTP>>
Gateway --> HelperSvc : <<HTTP>>
Gateway --> BranchOwner : <<HTTP>>
Gateway --> Access : <<HTTP>>

Auth --> CC : <<HTTP>> Card verify
Search --> ExtLLM : <<HTTP>> Keyword extraction
Search --> AIService : <<HTTP>> LLM analysis
HelperSvc --> Broker : <<RabbitMQ>> publish tasks

HelperSvc --> Broker : <<RabbitMQ>> tasks.submitted/confirmed
Search --> Broker : <<RabbitMQ>> publish preferences
BranchOwner --> Broker : <<RabbitMQ>> branch.info.created
Access --> Broker : <<RabbitMQ>> access_attempt
Monitor --> Broker : <<RabbitMQ>> faults/heartbeat

Broker --> HelperSvc : <<RabbitMQ>> tasks.* subscriptions
Broker --> Search : <<RabbitMQ>> preferences updates
Broker --> BranchOwner : <<RabbitMQ>> branch events
Broker --> Notify : <<RabbitMQ>> faults topic

Notify --> PushGW : <<HTTP>> push alert
PushGW --> Ops : <<HTTPS>> Pager/Push

Equipment --> Access : <<Local>> face vectors
Access --> Equipment : <<Local>> gate control
Equipment --> Monitor : <<TCP>> heartbeat/status

Access --> PanDoku : <<IPC>> generateVector()
Access --> FaceModel : <<IPC>> IFaceModelService
FaceModel --> PanDoku : <<IPC>> deployModel(), trainModel()
Search --> PanDoku : <<Local>> analyzeQuery()
AIService --> PanDoku : <<Local>> analyzeQuery()
Monitor --> PanDoku : <<Local>> monitorModel(), getModelStatus()

@enduml
