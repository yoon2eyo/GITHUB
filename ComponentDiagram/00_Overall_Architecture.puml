@startuml OverallComponentDiagram
!pragma layout smetana
skinparam componentStyle rectangle
skinparam packageStyle rectangle

actor "Customer App" as Customer
actor "Helper App" as Helper
actor "Branch Manager App" as Manager
actor "Operations Center" as Ops

cloud "External Partners" {
  component "ICreditCardVerificationService" as CC
  component "ILLMAnalysisService" as ExtLLM
}

node "Branch Equipment & Cameras" as Equipment
component "IPushNotificationGateway" as PushGW

rectangle "Smart Fitness Cloud" {
  component "RequestRouter (ApiGateway)" as ApiGateway
  queue "RabbitMQ (Message Broker)" as Broker

  package "Real-Time Access Layer" {
    component "AccessAuthorizationManager" as Access
    component "VectorComparisonEngine (FACE MODEL)" as FaceModel
  }

  package "Business Logic Layer" {
    component "AuthenticationManager" as Auth
    component "BranchContentService" as Search
    component "TaskManagementManager" as HelperSvc
    component "BranchOwnerManager" as BranchOwner
    component "StatusReceiverManager" as Monitor
    component "NotificationDispatcherConsumer" as Notify
  }

  package "AI Pipeline Layer" {
    component "MLOpsTrainingService" as MLOps
    component "MLInferenceEngine (Internal ML Platform)" as MLEngine
  }
}

' Client → ApiGateway
Customer --> ApiGateway : HTTPS /auth,/search
Helper --> ApiGateway : HTTPS /helper
Manager --> ApiGateway : HTTPS /branch
Ops --> ApiGateway : HTTPS /ops console

' ApiGateway → Services (Synchronous)
ApiGateway --> Auth : <<HTTP>>
ApiGateway --> Search : <<HTTP>>
ApiGateway --> HelperSvc : <<HTTP>>
ApiGateway --> BranchOwner : <<HTTP>>
ApiGateway --> Access : <<HTTP>>

' External System Integration
Auth --> CC : <<HTTP>> Card verify
Search --> ExtLLM : <<HTTP>> Cold Path: Keyword extraction

' Real-Time Access Layer (DD-05: IPC Optimization)
Equipment --> Access : <<HTTPS>> face photo
Access --> FaceModel : <<IPC>> calculateSimilarityScore()
Access --> Equipment : <<HTTPS>> gate control
FaceModel --> MLEngine : <<Local>> model inference

note right of Access
  DD-05: Same Physical Node
  - Access ↔ FaceModel: IPC/gRPC
  - Latency: ~205ms (parallelized)
  - Data Pre-Fetching: Face vectors cached
end note

' Message Broker (Asynchronous Event Flow)
HelperSvc --> Broker : <<Publish>> TaskSubmittedEvent
HelperSvc --> Broker : <<Publish>> TaskConfirmedEvent
Search --> Broker : <<Publish>> BranchPreferenceCreatedEvent
BranchOwner --> Broker : <<Publish>> BranchInfoCreatedEvent
Monitor --> Broker : <<Publish>> EquipmentFaultEvent

Broker --> Notify : <<Subscribe>> EquipmentFaultEvent
Notify --> PushGW : <<HTTP>> push alert
PushGW --> Manager : <<HTTPS>> Alert to Branch Owner

' Equipment Monitoring (DD-04: Heartbeat)
Equipment --> Monitor : <<TCP>> heartbeat/status
Monitor --> Equipment : <<HTTPS>> ping/status request

' MLOps & AI Pipeline
MLOps --> MLEngine : <<Local>> deployModel(), trainModel()
MLOps --> Auth : <<JDBC READ-ONLY>> facial data
MLOps --> HelperSvc : <<JDBC READ-ONLY>> laundry data

@enduml
