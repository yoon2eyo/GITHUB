@startuml AccessAuthorizationManager_SequenceDiagram
title AccessAuthorizationManager 컴포넌트 시퀀스 다이어그램\n(Required Interface 호출 범위)
autonumber

' External Caller (Provided Interface 호출자)
participant "AccessControlController\n<<Interface Layer>>\n(Provided Interface 호출자)" as Controller

' AccessAuthorizationManager Component
box "AccessAuthorizationManager Component" #LightBlue
  participant "AccessAuthorizationManager\n<<Business>>\nimplements IAccessAuthorizationService\n(Provided Interface)" as AuthManager
end box

' Required Interfaces
box "Required Interfaces" #LightGreen
  participant "FaceVectorCache\n<<Required Interface>>" as Cache
  participant "IFaceModelServiceClient\n<<Required Interface>>" as FaceModelClient
  participant "IGateControlService\n<<Required Interface>>" as GateService
  participant "IAccessEventPublisher\n<<Required Interface>>" as EventPublisher
end box

== 안면인식 출입 인증 (UC-07) ==

' Step 1: Provided Interface 호출
Controller -> AuthManager : authorizeFaceAccess(branchId, equipmentId, facePhoto)
activate AuthManager
note right
  **Provided Interface:**
  IAccessAuthorizationService.authorizeFaceAccess()
  
  **Design Pattern: Facade Pattern**
  - 복잡한 출입 인증 프로세스를
    단순한 인터페이스로 제공
  - 클라이언트는 내부 복잡성 모름
end note

' Step 2: 안면 사진 바이트 변환 (Internal Operation)
AuthManager -> AuthManager : facePhoto.getBytes()
note right
  **Internal Operation**
  MultipartFile → byte[]
end note

' Step 3: Required Interface 호출 - 캐시에서 벡터 조회
AuthManager -> Cache : getActiveVector(branchId)
activate Cache
note left
  **Required Interface: FaceVectorCache**
  
  **Tactic: Data Pre-Fetching (DD-05)**
  - Startup 시 상위 10K 벡터 미리 로드
  - Cache hit rate: >90%
  - Response time: ~5ms (vs DB: ~50ms)
  - DB I/O를 Hot Path에서 제거
  
  **QAS-02 (Performance):**
  - 데이터 조회 시간 90% 감소
  - 핵심 병목 구간 최적화
  
  **Design Pattern: Cache-Aside Pattern**
  - 캐시 미스 시 DB 조회 후 캐시 업데이트
end note
Cache --> AuthManager : FaceVectorDto
deactivate Cache

' Step 4: Required Interface 호출 - FaceModel Service IPC
AuthManager -> FaceModelClient : calculateSimilarity(photoBytes, cachedVector)
activate FaceModelClient
note right
  **Required Interface: IFaceModelServiceClient**
  
  **Tactic: Same Physical Node (DD-05)**
  - Access Service와 FaceModel Service
    동일 물리 노드에 배치
  - IPC/gRPC 통신으로 네트워크 오버헤드 제거
  - HTTP REST 대비 10-20ms 지연 감소
  
  **Tactic: Pipeline Optimization (DD-05)**
  - 병렬 특징점 추출 (CompletableFuture)
  - 순차: 405ms → 병렬: 205ms (49% 감소)
  
  **QAS-02 (Performance):**
  - 가장 큰 병목 구간 최적화
  - 전체 응답 시간의 64% 차지
  
  **Design Pattern: Strategy Pattern**
  - IFaceModelServiceClient 인터페이스로
    다양한 구현체 교체 가능
  - Dependency Inversion Principle (DIP)
end note
FaceModelClient --> AuthManager : SimilarityResultDto{userId, score, isMatch}
deactivate FaceModelClient

' Step 5: 출입 결정 (Internal Logic)
AuthManager -> AuthManager : checkSimilarity(similarity, threshold)
note right
  **Internal Operation**
  - Threshold: 0.85
  - Decision: isMatch && score >= threshold
  
  **QAS-02 (Performance):**
  - 결정 로직: ~10ms
  - 빠른 판단으로 지연 최소화
end note

alt [GRANTED] similarity >= threshold && isMatch == true
  ' Step 6: Required Interface 호출 - 게이트 개방
  AuthManager -> GateService : openGate(equipmentId)
  activate GateService
  note left
    **Required Interface: IGateControlService**
    
    **UC-22: Gate Open Execution**
    - Target: < 1초 after recognition
    - QAS-02 requirement
    
    **Design Pattern: Strategy Pattern**
    - IGateControlService 인터페이스로
      다양한 게이트 제어 구현체 교체 가능
    - Adapter Pattern (구현체에서 적용)
  end note
  GateService --> AuthManager : true
  deactivate GateService
  
  ' Step 7: Required Interface 호출 - 이벤트 발행
  AuthManager -> EventPublisher : publishAccessGranted(AccessGrantedEvent)
  activate EventPublisher
  note right
    **Required Interface: IAccessEventPublisher**
    
    **Tactic: Event-Based Architecture (DD-02)**
    - RabbitMQ Durable Queue
    - 비동기 이벤트 발행
    - 느슨한 결합 (Loose Coupling)
    - Passive Redundancy
    
    **QAS-04 (Security):**
    - Audit Trail: 모든 출입 시도 기록
    - 보안 감사 추적 가능
    - 비정상 패턴 분석
    
    **QAS-02 (Performance):**
    - 비동기 처리로 핫 패스 영향 없음
    - ~10ms (논블로킹)
    
    **Design Pattern: Observer Pattern**
    - Pub/Sub 구조
    - 여러 구독자에게 이벤트 전달
    - 이벤트 기반 통합
  end note
  EventPublisher --> AuthManager : void
  deactivate EventPublisher
  
  ' Step 8: 응답 반환
  AuthManager --> Controller : Map{result: "GRANTED", userId, similarityScore, processingTimeMs}
  deactivate AuthManager
  note right
    **QAS-02 (Performance):**
    - Total time: ~320ms
    - Target: < 3초 (95%)
    - ✓ Target met (10.7% of target)
    
    **성능 분석:**
    - Cache: ~5ms (1.6%)
    - IPC: ~205ms (64.1%)
    - Gate: ~100ms (31.2%)
    - Event: ~10ms (3.1%)
    
    **Peak Load (20 TPS):**
    - Thread Pool로 동시 처리
    - 각 요청 독립 처리
  end note

else [DENIED] similarity < threshold || isMatch == false
  ' Step 6: 게이트 개방 없음 (DENIED)
  note over AuthManager
    **No Gate Opening**
    - Access denied
    - Gate remains closed
    - IGateControlService 호출 생략
    
    **QAS-04 (Security):**
    - 거부된 접근 시도도 기록
    - 보안 감사 추적
  end note
  
  ' Step 7: Required Interface 호출 - 거부 이벤트 발행
  AuthManager -> EventPublisher : publishAccessDenied(AccessDeniedEvent)
  activate EventPublisher
  note left
    **Required Interface: IAccessEventPublisher**
    
    **Tactic: Event-Based Architecture (DD-02)**
    - AccessDeniedEvent 발행
    - 비동기 처리
    
    **QAS-04 (Security):**
    - Audit Trail: 모든 출입 시도 기록
    - 실패 원인 분석 가능
    - 보안 모니터링
    
    **Design Pattern: Observer Pattern**
    - 보안 모니터링 시스템이
      이벤트 구독 가능
  end note
  EventPublisher --> AuthManager : void
  deactivate EventPublisher
  
  AuthManager --> Controller : Map{result: "DENIED", reason: "NO_MATCH", similarityScore}
  deactivate AuthManager
  note right
    **QAS-02 (Performance):**
    - Total time: ~220ms
    - 게이트 제어 단계 생략으로
      더 빠른 응답
  end note
end

== Design Pattern & Tactics 요약 ==
note over Controller, EventPublisher
  **적용된 Design Pattern:**
  
  1. **Facade Pattern**
     - AccessAuthorizationManager가 복잡한
       출입 인증 프로세스를 단순화
  
  2. **Strategy Pattern**
     - IFaceModelServiceClient
     - IGateControlService
     - 인터페이스로 구현체 교체 가능
  
  3. **Observer Pattern**
     - IAccessEventPublisher
     - 이벤트 기반 Pub/Sub 구조
  
  4. **Adapter Pattern** (구현체에서)
     - FaceModelServiceIPCClient
     - GateController
  
  5. **Cache-Aside Pattern**
     - FaceVectorCache
  
  **적용된 Tactics (DD-05, DD-02):**
  
  1. **Data Pre-Fetching**
     - 캐시 히트율 >90%
     - DB I/O 제거
  
  2. **Same Physical Node**
     - IPC/gRPC 통신
     - 네트워크 지연 제거
  
  3. **Pipeline Optimization**
     - 병렬 처리
     - 49% 지연 감소
  
  4. **Event-Based Architecture**
     - 느슨한 결합
     - 비동기 처리
end note

== QAS 요약 ==
note over Controller, EventPublisher
  **QAS-02: 신속하고 정확한 안면인식 출입 인증 (Performance)**
  
  **목표:**
  - 95% 요청이 3초 이내 응답
  - 게이트 개방: 판독 성공 후 1초 이내
  
  **달성 전략:**
  1. Data Pre-Fetching: 50ms → 5ms (90% 감소)
  2. Pipeline Optimization: 405ms → 205ms (49% 감소)
  3. Same Physical Node: 네트워크 지연 제거
  4. 비동기 이벤트: 핫 패스 영향 없음
  
  **측정 결과:**
  - GRANTED: ~320ms (목표의 10.7%)
  - DENIED: ~220ms (목표의 7.3%)
  - ✓ 목표 달성
  
  **QAS-04: 민감 정보 접근 감사로그 (Security)**
  
  **목표:**
  - 모든 출입 시도 기록
  - 보안 감사 추적 가능
  
  **달성 전략:**
  1. Event-Based Architecture
  2. AccessGrantedEvent / AccessDeniedEvent
  3. 비동기 이벤트 발행
  4. RabbitMQ Durable Queue
  
  **기록 내용:**
  - userId, branchId, equipmentId
  - similarityScore, timestamp
  - result (GRANTED/DENIED), reason
end note

@enduml
