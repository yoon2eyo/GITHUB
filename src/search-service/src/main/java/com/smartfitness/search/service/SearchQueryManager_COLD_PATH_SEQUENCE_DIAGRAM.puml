@startuml SearchQueryManager_ColdPath_SequenceDiagram
title SearchQueryManager 컴포넌트 Cold Path 시퀀스 다이어그램\n(검색 쿼리 개선 - DD-09)

' Message Broker (이벤트 발행자)
participant "RabbitMQ" as RabbitMQ

' Domain Event
box "Domain Event" #LightCyan
  participant "SearchQueryEvent" as Event
end box

' Cold Path Component
box "Cold Path Component" #LightBlue
  participant "SearchQueryImprovementConsumer" as Consumer
end box

' Required Interfaces
box "Required Interfaces" #LightGreen
  participant "ILLMAnalysisServiceClient" as LLMClient
  participant "LLMServiceClient" as LLMService
  participant "ISearchEngineRepository" as SearchRepo
  participant "ElasticSearchRepository" as ElasticRepo
end box

== Cold Path: 검색 쿼리 개선 (DD-09) ==

' Step 1: 이벤트 수신 (비동기)
RabbitMQ -> Consumer : [1.1] handleSearchQueryEvent(SearchQueryEvent)
activate Consumer
note right
  **SearchQueryImprovementConsumer**
  **Observer Pattern 적용**
  - SearchQueryEvent 구독
  - 비동기 이벤트 처리
  - Hot Path와 완전 분리
  
  **시작점:** Message Broker (RabbitMQ)로부터
    이벤트 수신 (비동기)
  
  **QAS-05 (Availability):**
  - Hot Path와 독립적으로 동작
  - Cold Path 장애가 Hot Path에 영향 없음
end note

' Step 2: 샘플링 체크
Consumer -> Consumer : [1.2] shouldProcessQuery(event)
note right
  **Internal Operation**
  **Sampling Tactic (DD-09):**
  - 10% 샘플링 정책 적용
  - 해시 기반 일관성 보장
  - event.getQuery().hashCode() % 10 == 0
  - 동일 쿼리는 항상 처리되거나 스킵
  
  **Sampling Tactic (DD-09):**
  - 10% 샘플링으로 LLM 호출 비용 절감
  - 대표적인 쿼리 패턴 수집으로 효과 유지
end note

alt [shouldProcessQuery == true] 10% 샘플링 통과
  ' Step 3: Required Interface 호출 - LLM 키워드 추출
  Consumer -> LLMClient : [1.3] extractKeywords(query)
  activate LLMClient
  note left
    **Required Interface: ILLMAnalysisServiceClient**
    **Cold Path에서만 사용**
    - Hot Path에서는 호출되지 않음
    - Strategy Pattern 적용으로
      다양한 LLM 서비스 교체 가능
  end note
  
  LLMClient -> LLMService : [1.4] extractKeywords(query)
  activate LLMService
  note right
    **LLMServiceClient**
    **Cold Path 처리:**
    - 외부 LLM 서비스 호출 (예: OpenAI API)
    - 자연어 쿼리에서 키워드 추출
    - 감정 분석 (sentiment)
    - 카테고리 분류 (category)
    - 처리 시간: ~1000ms
    - Hot Path에 영향 없음 (비동기)
    
    **Sampling Tactic (DD-09):**
    - 10% 샘플링으로 LLM 호출 비용 절감
    - 비동기 처리로 성능 영향 없음
    
    **QAS-05 (Availability):**
    - LLM 서비스 장애 시에도
      Hot Path는 정상 동작
  end note
  LLMService --> LLMClient : [1.4] Map<String, Object> analysis{keywords, sentiment, category}
  deactivate LLMService
  LLMClient --> Consumer : [1.3] Map<String, Object> analysis
  deactivate LLMClient
  
  ' Step 4: 인덱스 개선
  Consumer -> Consumer : [1.5] updateSearchIndex(query, keywords)
  note right
    **Internal Operation**
    - LLM에서 추출한 키워드로
      ElasticSearch 인덱스 개선
    - 동의어 사전 업데이트
    - 쿼리 확장 인덱스 업데이트
    - 향후 검색 정확도 향상
  end note
  
  Consumer -> SearchRepo : [1.6] index(documentId, document)
  activate SearchRepo
  SearchRepo -> ElasticRepo : [1.7] index(documentId, document)
  activate ElasticRepo
  note left
    **ElasticSearchRepository**
    **Cold Path 인덱싱:**
    - 개선된 키워드로 인덱스 업데이트
    - 동의어 사전 업데이트
    - 향후 검색 정확도 향상
    - 비동기 처리로 Hot Path 영향 없음
    
    **QAS-06 (Modifiability):**
    - 인덱스 개선 로직 변경이
      Hot Path에 영향 없음
  end note
  ElasticRepo --> SearchRepo : [1.7] void
  deactivate ElasticRepo
  SearchRepo --> Consumer : [1.6] void
  deactivate SearchRepo
  
  note over Consumer, ElasticRepo
    **Cold Path 완료**
    - 인덱스 개선 완료
    - 향후 검색 정확도 향상
    - 비동기 처리로 Hot Path 영향 없음
    - 처리 시간: ~1101ms (비동기)
  end note
else [shouldProcessQuery == false] 90% 샘플링 스킵
  note over Consumer
    **샘플링 스킵**
    - 90% 쿼리는 LLM 분석 생략
    - 비용 효율성 확보
    - Sampling Tactic 적용
    - 처리 시간: ~1ms (샘플링 체크만)
  end note
end

Consumer -> Consumer : [1.8] (처리 완료)
deactivate Consumer

== Design Pattern & Tactics 요약 ==
note over RabbitMQ, ElasticRepo
  **Cold Path 컴포넌트의 핵심 설계 요소**

  **1. 가용성 (QAS-05)**
  - **Fault Isolation**: Cold Path 장애가 Hot Path에 영향 없음
  - **LLM 서비스 장애 격리**: LLM 장애 시에도 Hot Path 정상 동작
  - **Design Pattern**: Observer Pattern

  **2. 유지보수성 (QAS-06)**
  - **Strategy Pattern**: 다양한 LLM 서비스 전략 교체 가능
  - **Hot/Cold Path Separation**: 독립적 수정 가능
  - **Design Pattern**: Strategy, Observer

  **4. 인덱스 개선 효과**
  - **지속적 개선**: Cold Path에서 수집된 데이터로 인덱스 지속 개선
  - **검색 정확도 향상**: 향후 검색 정확도 향상으로 사용자 만족도 증가
  - **장기적 효과**: 시간이 지날수록 검색 품질 향상
end note

@enduml

