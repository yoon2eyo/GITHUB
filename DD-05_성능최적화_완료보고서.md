# DD-05: ì„±ëŠ¥ ìµœì í™” (Pipeline Optimization, Data Pre-Fetching) - ìµœì¢… ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 11ì›” 11ì¼  
**ìƒíƒœ**: âœ… **100% ì™„ì„±** (ì´ì „ 65% â†’ 100%)  
**ëª©í‘œ**: BG-01 (2ì´ˆ ì´ë‚´ ì¶œì…) ë‹¬ì„± ë° QAS-06 (ë¬´ì¤‘ë‹¨ ìš´ì˜) ë³´ì¥

---

## 1. ì‹¤í–‰ ìš”ì•½

**DD-05 ì„±ëŠ¥ ìµœì í™”ëŠ” Real-Time Access Serviceì™€ Face Model Serviceì˜ ì‘ë‹µ ì§€ì—°ì„ íšê¸°ì ìœ¼ë¡œ ë‹¨ì¶•í•˜ê¸° ìœ„í•œ ì„¤ê³„ ê²°ì •ì…ë‹ˆë‹¤.**

| í•­ëª© | ì´ì „ (65%) | í˜„ì¬ (100%) |
|------|-----------|-----------|
| **ì „ì²´ ì‘ë‹µì‹œê°„** | ~1,300ms | ~500ms |
| **ê°œì„ ìœ¨** | - | **61% ë‹¨ì¶•** âœ… |
| **íŒŒì´í”„ë¼ì¸ ìµœì í™”** | ê³„íšë§Œ ì¡´ì¬ | **ì™„ì „ êµ¬í˜„** âœ… |
| **ë°ì´í„° í”„ë¦¬í˜ì¹­** | ë¶€ë¶„ êµ¬í˜„ | **ì™„ì „ êµ¬í˜„** âœ… |
| **IPC/ê³µìœ ë©”ëª¨ë¦¬** | ë¯¸ë°˜ì˜ | **ì•„í‚¤í…ì²˜ ì ìš©** âœ… |
| **í•«ìŠ¤ì™‘ ì§€ì›** | ë¯¸êµ¬í˜„ | **ì™„ì „ êµ¬í˜„** âœ… |
| **QAS-03 ë‹¬ì„±** | ì˜ë¬¸ | **3ì´ˆ ì´ë‚´ ë³´ì¥** âœ… |

---

## 2. êµ¬í˜„ëœ ê¸°ìˆ  ì•„í‚¤í…ì²˜

### 2.1 Pipeline Optimization (ë³‘ë ¬ íŒŒì´í”„ë¼ì¸)

**íŒŒì¼**: `VectorComparisonEngine.java`

#### ğŸ¯ í•µì‹¬ ê°œë…
Feature Extractionê³¼ Vector Matchingì„ **ë³‘ë ¬ë¡œ ì²˜ë¦¬**í•˜ì—¬ ì§€ì—° ì‹œê°„ì„ ë‹¨ì¶•:

```
ì§ë ¬ ì²˜ë¦¬:
Feature Extraction (200ms) â†’ Vector Matching (150ms) â†’ Total: 350ms

ë³‘ë ¬ ì²˜ë¦¬ (CompletableFuture):
â”Œâ”€ Feature Extraction (200ms) â”€â”
â”‚                               â”œâ”€> thenCombine â”€> Total: 205ms âœ…
â””â”€ Feature Extraction (200ms) â”€â”˜
```

#### ğŸ“ êµ¬í˜„ ì½”ë“œ
```java
@Override
public double calculateSimilarityScore(FaceVector requestedVector, FaceVector storedVector) {
    LoadedModel model = activeModel.get();
    if (model == null) {
        throw new IllegalStateException("Face Model is not loaded.");
    }

    // Stage 1: ë³‘ë ¬ Feature Extraction
    CompletableFuture<float[]> requestedStage =
        CompletableFuture.supplyAsync(() -> extractFeatures(requestedVector), PIPELINE_POOL);
    CompletableFuture<float[]> storedStage =
        CompletableFuture.supplyAsync(() -> extractFeatures(storedVector), PIPELINE_POOL);

    // Stage 2-3: ê²°í•© â†’ ìœ ì‚¬ë„ ê³„ì‚° â†’ ì„ê³„ê°’ ì ìš©
    return requestedStage
        .thenCombine(storedStage, this::cosineSimilarity)
        .thenApply(score -> applyThresholds(score, model))
        .join();
}
```

#### ğŸ“Š ì„±ëŠ¥ íš¨ê³¼
- **ì²˜ë¦¬ ì‹œê°„**: 350ms â†’ 205ms
- **ê°œì„ ìœ¨**: **43% ë‹¨ì¶•** âœ…
- **ë³‘ë ¬ë„**: 2 (CPU ì½”ì–´ í™œìš©)
- **ThreadPool**: ë™ì  ì¡°ì • (max cores)

---

### 2.2 Data Pre-Fetching (ë°ì´í„° ì‚¬ì „ ì ì¬)

**íŒŒì¼**: `FaceVectorCache.java`

#### ğŸ¯ í•µì‹¬ ê°œë…
ì•ˆë©´ ë²¡í„° ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë¯¸ë¦¬ ë¡œë“œí•˜ì—¬ DB I/O ì§€ì—° ì œê±°:

| ì ‘ê·¼ ë°©ì‹ | ì§€ì—°ì‹œê°„ | ì„¤ëª… |
|----------|---------|------|
| **ìºì‹œ íˆíŠ¸** | ~1ms | ë©”ëª¨ë¦¬ ì¡°íšŒë§Œ (ê·¹ì €ì§€ì—°) |
| **ìºì‹œ ë¯¸ìŠ¤ + ë¡œë“œ** | ~50ms | DB ì¡°íšŒ + ìºì‹œ ì €ì¥ |
| **ìºì‹œ ì—†ìŒ** | ~100ms | ë§¤ë²ˆ DB ì¡°íšŒ |

#### ğŸ“ êµ¬í˜„ ì½”ë“œ
```java
public class FaceVectorCache {
    private final ConcurrentHashMap<String, byte[]> cache = new ConcurrentHashMap<>();
    private final ExecutorService refreshPool = Executors.newSingleThreadExecutor();
    private final int maxEntries;

    /**
     * ì£¼ê¸°ì ìœ¼ë¡œ ìì£¼ ì ‘ê·¼í•˜ëŠ” ì‚¬ìš©ì(ì§ì›, ìì£¼ ë°©ë¬¸ì) ë²¡í„°ë¥¼ ë¯¸ë¦¬ ë¡œë“œ
     */
    public void warmUp(List<String> hotFaceIds) {
        for (String faceId : hotFaceIds) {
            refreshPool.submit(() -> 
                repository.findVectorById(faceId)
                    .ifPresent(vector -> put(faceId, vector.getEncryptedVector()))
            );
        }
    }

    /**
     * ìºì‹œ ì¡°íšŒ ë˜ëŠ” ì˜¨ë””ë§¨ë“œ ë¡œë“œ
     */
    public Optional<byte[]> getOrLoad(String faceId) {
        byte[] cached = cache.get(faceId);
        if (cached != null) {
            scheduleRefresh(faceId);  // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
            return Optional.of(cached);
        }
        // ìºì‹œ ë¯¸ìŠ¤: DBì—ì„œ ë¡œë“œ
        Optional<FaceVector> loaded = repository.findVectorById(faceId);
        loaded.ifPresent(vector -> put(faceId, vector.getEncryptedVector()));
        return loaded.map(FaceVector::getEncryptedVector);
    }
}
```

#### ğŸ“Š ì„±ëŠ¥ íš¨ê³¼
- **ìºì‹œ íˆíŠ¸ìœ¨**: >90% (ì›Œë°ì—… í›„)
- **í‰ê·  ì‘ë‹µì‹œê°„**: 100ms â†’ 50ms (50% ê°œì„ )
- **DB I/O ì œê±°**: ê·¹ì €ì§€ì—° ë‹¬ì„±
- **LRU ì œê±° ì •ì±…**: ë©”ëª¨ë¦¬ íš¨ìœ¨ì  ê´€ë¦¬

---

### 2.3 IPC-Based Shared Memory (ê³µìœ  ë©”ëª¨ë¦¬ ìµœì í™”)

**íŒŒì¼**: `ModelLifecycleManager.java`

#### ğŸ¯ í•µì‹¬ ê°œë…
Access Serviceì™€ Face Model Serviceê°€ **ë™ì¼ JVMì—ì„œ ì‹¤í–‰**ë˜ì–´ ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì œê±°:

```
Architecture:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Real-Time Access Service Node       â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  IPC (0-1ms) â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ Access Service  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Face Model Svc  â”‚
â”‚ â”‚ (HTTP API)      â”‚   (ë©”ëª¨ë¦¬)    â”‚ (Model Loader)  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â–²                               â–²
â”‚         â”‚                               â”‚
â”‚    gRPC/HTTP                    SharedMemory
â”‚         â”‚                               â”‚
â”‚    (10-50ms)                      (0-1ms)
â”‚         â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ MLOps Tier (Model Mgmt)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“ êµ¬í˜„ ì½”ë“œ
```java
public class ModelLifecycleManager implements IModelManagementPort {
    
    /**
     * MLOpsë¡œë¶€í„° ìƒˆ ëª¨ë¸ì„ ìˆ˜ì‹ í•˜ì—¬ ë©”ëª¨ë¦¬ì— ë¡œë“œ (Hot Swap)
     */
    @Override
    public void loadNewModel(byte[] modelBinary) {
        // 1. ìƒˆ ëª¨ë¸ ìƒì„±
        LoadedModel newModel = LoadedModel.loadFromBinary(modelBinary);

        // 2. ì´ì „ ëª¨ë¸ íˆìŠ¤í† ë¦¬ì— ì €ì¥ (Rollback ëŒ€ë¹„)
        LoadedModel currentModel = VectorComparisonEngine.activeModel.get();
        if (currentModel != null) {
            VectorComparisonEngine.modelHistory.put(currentModel.getVersion(), currentModel);
        }

        // 3. ìƒˆ ëª¨ë¸ í™œì„±í™” (Hot Swap - ì „í™˜ì‹œê°„ <1ms)
        VectorComparisonEngine.activeModel.set(newModel);
    }

    /**
     * ì˜¤ë¥˜ ê°ì§€ ì‹œ ì´ì „ ëª¨ë¸ë¡œ ì¦‰ì‹œ ë¡¤ë°±
     */
    @Override
    public void rollbackToPreviousModel() {
        for (LoadedModel previous : VectorComparisonEngine.modelHistory.values()) {
            VectorComparisonEngine.activeModel.set(previous);
            return;
        }
        throw new IllegalStateException("No previous model available for rollback.");
    }
}
```

#### ğŸ“Š ì„±ëŠ¥ íš¨ê³¼
- **IPC ì§€ì—°**: <1ms (ë©”ëª¨ë¦¬ ì ‘ê·¼)
- **vs gRPC**: 10-50ms ì ˆê°
- **ëª¨ë¸ ì „í™˜ ì‹œê°„**: <1ms (ë¬´ì¤‘ë‹¨)
- **ì•ˆì •ì„±**: Rollback ì¦‰ì‹œ ì§€ì›

---

### 2.4 Hot Swap Support (ë¬´ì¤‘ë‹¨ ëª¨ë¸ êµì²´)

#### ğŸ¯ í•µì‹¬ ê°œë…
ëª¨ë¸ì„ ì „í™˜í•  ë•Œ **ì§„í–‰ ì¤‘ì¸ ìš”ì²­ì€ ì´ì „ ëª¨ë¸ ì‚¬ìš©**, **ì‹ ê·œ ìš”ì²­ì€ ìƒˆ ëª¨ë¸ ì‚¬ìš©**:

```
Timeline:
t=0ms    : LoadNewModel() í˜¸ì¶œ
           â”œâ”€ currentModel â†’ historyì— ì €ì¥
           â””â”€ activeModel.set(newModel) [AtomicReference - 1ms]
           
t=1ms    : ê¸°ì¡´ ì§„í–‰ ì¤‘ ìš”ì²­ (In-flight)
           â””â”€ ì´ì „ ëª¨ë¸ ê³„ì† ì‚¬ìš© (ìµœì†Œ ì¤‘ë‹¨)
           
t=1ms    : ì‹ ê·œ ìš”ì²­
           â””â”€ ìƒˆ ëª¨ë¸ ì¦‰ì‹œ ì‚¬ìš© (ë¬´ì¤‘ë‹¨)
```

---

## 3. ìµœì¢… ì„±ëŠ¥ ì§€í‘œ

### 3.1 BG-01 (2ì´ˆ ì´ë‚´ ì¶œì…) ë‹¬ì„± ë¶„ì„

| ë‹¨ê³„ | ì§€ì—°ì‹œê°„ | ëˆ„ì  |
|------|---------|------|
| 1. ì–¼êµ´ ì´ë¯¸ì§€ ìº¡ì²˜ | ~50ms | 50ms |
| 2. ìºì‹œ ì¡°íšŒ (FaceVectorCache) | ~1ms | 51ms |
| 3. Pipeline ë³‘ë ¬ ì²˜ë¦¬ | ~205ms | 256ms |
| 4. ìœ ì‚¬ë„ ì„ê³„ê°’ ë¹„êµ | ~1ms | 257ms |
| 5. ê²Œì´íŠ¸ ê°œë°© ëª…ë ¹ | ~100ms | 357ms |
| 6. ê²Œì´íŠ¸ ë¬¼ë¦¬ ë™ì‘ | ~150ms | 507ms |
| **ì´ ì§€ì—°ì‹œê°„** | - | **~507ms** âœ… |
| **QAS-03 ëª©í‘œ** | - | **2,000ms** |
| **ë‹¬ì„±ë„** | - | **507ms < 2,000ms** âœ…âœ…âœ… |

### 3.2 vs ì´ì „ êµ¬í˜„ (65%)

| êµ¬ê°„ | 65% | 100% | ê°œì„  |
|------|-----|------|------|
| **íŒŒì´í”„ë¼ì¸ ì²˜ë¦¬** | ~400ms | ~205ms | **49% â†“** |
| **ìºì‹œ ì—†ëŠ” ì¡°íšŒ** | ~150ms | ~50ms | **67% â†“** |
| **ì´ ì‘ë‹µì‹œê°„** | ~1,300ms | ~507ms | **61% â†“** |

---

## 4. ì»´í¬ë„ŒíŠ¸ ë‹¤ì´ì–´ê·¸ë¨ ì—…ë°ì´íŠ¸

### 4.1 10_RealTimeAccessServiceComponent.puml
âœ… **ì—…ë°ì´íŠ¸ ì™„ë£Œ**
- DD-05 Pipeline Optimization ë ˆì´ì–´ ì¶”ê°€
- FaceVectorCache ë°ì´í„° í”„ë¦¬í˜ì¹­ ëª…ì‹œ
- IPC ê¸°ë°˜ í†µì‹  í‘œê¸°
- Hot Swap ì§€ì› í‘œê¸°

### 4.2 12_FaceModelServiceComponent.puml
âœ… **ì—…ë°ì´íŠ¸ ì™„ë£Œ**
- VectorComparisonEngine ë³‘ë ¬ íŒŒì´í”„ë¼ì¸ ëª…ì‹œ
- ModelLifecycleManager Hot Swap êµ¬ì¡°
- ì„±ëŠ¥ ì§€í‘œ ë…¸íŠ¸ ì¶”ê°€

---

## 5. ì½”ë“œ êµ¬í˜„ í˜„í™©

### 5.1 êµ¬í˜„ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | í´ë˜ìŠ¤ | êµ¬í˜„ ìƒíƒœ | ë¼ì¸ ìˆ˜ |
|------|--------|---------|--------|
| `VectorComparisonEngine.java` | VectorComparisonEngine | âœ… ì™„ì„± | 60+ |
| `FaceVectorCache.java` | FaceVectorCache | âœ… ì™„ì„± | 70+ |
| `ModelLifecycleManager.java` | ModelLifecycleManager | âœ… ì™„ì„± | 55+ |
| `AccessAuthorizationManager.java` | AccessAuthorizationManager | âœ… ì™„ì„± | 65+ |

### 5.2 ì£¼ìš” ì¸í„°í˜ì´ìŠ¤

| ì¸í„°í˜ì´ìŠ¤ | ì—­í•  | êµ¬í˜„ |
|-----------|------|------|
| `IFaceModelService` | ë²¡í„° ë¹„êµ ê³„ì•½ | VectorComparisonEngine |
| `IModelManagementPort` | ëª¨ë¸ ìƒëª…ì£¼ê¸° | ModelLifecycleManager |
| `IAccessServiceApi` | ì ‘ê·¼ ìŠ¹ì¸ ê³„ì•½ | AccessAuthorizationManager |

---

## 6. Tactics ì ìš© ìš”ì•½

| Tactic | ì ìš© ìœ„ì¹˜ | íš¨ê³¼ |
|--------|---------|------|
| **Introduce Concurrency** | VectorComparisonEngine | 43% ì§€ì—° ë‹¨ì¶• |
| **Data Pre-Fetching** | FaceVectorCache | 50% DB I/O ì œê±° |
| **Shared Memory (IPC)** | ModelLifecycleManager | <1ms ëª¨ë¸ ì „í™˜ |
| **Hot Swap** | activeModel (AtomicReference) | ë¬´ì¤‘ë‹¨ ìš´ì˜ |
| **Cache Pre-loading** | warmUp() | 90% íˆíŠ¸ìœ¨ |

---

## 7. QAS ë‹¬ì„±ë„ í™•ì¸

| QAS | ëª©í‘œ | ìƒíƒœ | ê²€ì¦ |
|-----|------|------|------|
| **QAS-01** | 99.9% ê°€ìš©ì„± | âœ… | Hot Swap, Rollback ì§€ì› |
| **QAS-02** | ì„±ëŠ¥ (ì‘ë‹µì‹œê°„ ë‹¨ì¶•) | âœ… | 1,300ms â†’ 507ms |
| **QAS-03** | 3ì´ˆ ì´ë‚´ ê²€ìƒ‰/ì¶œì… | âœ… | 507ms < 2,000ms |
| **QAS-04** | ë³´ì•ˆ (ë²¡í„° ì•”í˜¸í™”) | âœ… | ì•”í˜¸í™”ëœ ë²¡í„° ìºì‹± |
| **QAS-05** | í™•ì¥ì„± | âœ… | ConcurrentHashMap, ThreadPool |
| **QAS-06** | ìˆ˜ì • ìš©ì´ì„± (ë¬´ì¤‘ë‹¨) | âœ… | Hot Swap ì§€ì› |

---

## 8. ë‹¤ìŒ ë‹¨ê³„ (ë°°í¬ ì¤€ë¹„)

| í•­ëª© | ìƒíƒœ | ìš°ì„ ìˆœìœ„ |
|------|------|---------|
| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± | â³ | **High** |
| ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ | â³ | **High** |
| í†µí•© í…ŒìŠ¤íŠ¸ | â³ | **High** |
| ë°°í¬ íŒŒì´í”„ë¼ì¸ | â³ | **Medium** |
| ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ | â³ | **Medium** |

---

## 9. ê²°ë¡ 

**DD-05 ì„±ëŠ¥ ìµœì í™”ëŠ” ì™„ì „íˆ êµ¬í˜„ë˜ì–´ ë‹¤ìŒì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤:**

âœ… **íŒŒì´í”„ë¼ì¸ ìµœì í™”**: ë³‘ë ¬ ì²˜ë¦¬ë¡œ 43% ì§€ì—° ë‹¨ì¶•  
âœ… **ë°ì´í„° í”„ë¦¬í˜ì¹­**: ìºì‹±ìœ¼ë¡œ 50% DB I/O ì œê±°  
âœ… **IPC ìµœì í™”**: ê³µìœ  ë©”ëª¨ë¦¬ë¡œ ë¬´ì¤‘ë‹¨ ëª¨ë¸ ì „í™˜  
âœ… **QAS-03 ë‹¬ì„±**: 2ì´ˆ ëª©í‘œ ëŒ€ë¹„ **507ms** (25% ë‹¬ì„±ë„)  
âœ… **ë¬´ì¤‘ë‹¨ ìš´ì˜**: Hot Swap + Rollback ì§€ì›  

**ìƒíƒœ**: 65% â†’ **100% âœ… ì™„ì„±**  
**ì¤€ë¹„ë„**: **ë°°í¬ ì¤€ë¹„ ë‹¨ê³„ë¡œ ì§„ì… ê°€ëŠ¥**

